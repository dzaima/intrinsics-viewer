#!/usr/bin/env bqn
DataIn â† "../data-in"âŠ¸â€¢file.At
âŸ¨ExportâŸ© â† â€¢Import DataIn "bqn-libs/json.bqn"

alnum â† '_' âˆ¾ âˆ¾"0aA"+âŸœâ†•Â¨ 10â€¿26â€¿26
lf â† @+10

Split â† (Â¬-ËœâŠ¢Ã—Â·+`Â»âŠ¸>)âˆ˜â‰ âŠ”âŠ¢
TrimWS â† {(âˆ¨`âˆ§âˆ¨`âŒ¾âŒ½)Â¬ğ•©âˆŠ' 'â€¿lf}âŠ¸/

all â† @
licenseNote â† @
{
  text â† â€¢FChars DataIn "wasm_simd128-1.h"
  licenseNote â†© textâ†‘Ëœ âŠ‘/lfâ€¿lf â· text
  all â†© @âŠ¸â‰¢Â¨âŠ¸/ {
    s â† ğ•©â†“text
    s â†© (1+âŠ‘sâŠ'{') â†‘ s
    s ' 'Â¨âŒ¾((s=lf)âŠ¸/)â†©
    s/Ëœâ†© Â¬ âˆ§âŸœÂ» s=' '
    Â¬âˆ¨Â´"__DEPRECATED_FN_ATTRS"â·s?
    !' '=âŠ‘17â†“s
    sâ†“Ëœâ†© 18
    p0â€¿p12 â† âŠ‘âˆ˜âŠâŸœ'('âŠ¸(â†‘â‹ˆâ†“)s # p0: "ret __ATTRS name"; p12: "(args) __REQUIRE_CONSTANT... {"
    head â† ' ' Split p0
    ! 2â‰¤â‰ head
    ret â† âŠ‘head
    name â† Â¯1âŠ‘head
    attrs â† Â¯1â†“1â†“head
    
    p12 "("âŠ¸âˆ¾â¼â†©
    p1â€¿p2 â† âŠ‘âˆ˜âŠâŸœ')'âŠ¸(â†‘â‹ˆâ†“)p12 # p1: "T0 a0, T1 a1, ..."; p2: ") __REQUIRE_CONSTANT... {"
    p2 ") "âŠ¸âˆ¾â¼â†©
    p2 âˆ¾âŸœ"{"â¼â†©
    p2 TrimWSâ†©
    constArgs â† {"__"âŠ¸âˆ¾â¼ âˆ¾âŸœ")"â¼ "__REQUIRE_CONSTANT("âŠ¸âˆ¾â¼ ğ•©}Â¨ ' ' Split p2
    
    args â† {
      tyâ€¿name â† (âˆ§`âŒ¾âŒ½ ğ•©âˆŠalnum) (Â¬âŠ¸/â‹ˆ/) ğ•©
      âŸ¨TrimWS ty, "__"âŠ¸âˆ¾â¼nameâŸ©
    }Â¨ ',' Split p1
    
    {ğ•Š:
      isConst â† (1âŠ‘Â¨args) âˆŠ constArgs
      ! (+Â´isConst) = â‰ constArgs
      args {ğ•¨ğ•Š0:ğ•¨; "const "âŠ¸âˆ¾âŒ¾âŠ‘ ğ•¨}Â¨â†© isConst
    }âŸ(Ã—â‰ constArgs) @
    
    ext â† âŠ‘âŸœ"simd128"â€¿"relaxed-simd"â€¿"fp16" â‹ˆâ¼ "__DEFAULT_FN_ATTRS"â€¿"__RELAXED_FN_ATTRS"â€¿"__FP16_FN_ATTRS" âŠ attrs
    [
      "ret"â€¿"ext"â€¿"name"â€¿"args"
      retâ€¿extâ€¿nameâ€¿args
    ]
    ;@
  }Â¨ /"static __inline__" â· text
}

# intrinsics done via defines
allâˆ¾â†© {
  # FP16Type â† {"float"â€¿n: "float16_t"â€¿n; ğ•©}Â¨âŒ¾(3âŠ‘âŠ¢) {"v128_t":ğ•©; "float": "float16_t"}âŒ¾âŠ‘
  FP16Type â† âŠ¢
  [
    âŠğ•©
    {"wasm_f16x8"âˆ¾"wasm_f32x4"âˆ¾â¼ğ•©}âŒ¾(2âŠ¸âŠ‘) "fp16"âŒ¾(1âŠ¸âŠ‘) FP16Type 1âŠğ•©
  ]
}Â¨ ("wasm_f32x4_extract_lane"â€¿"wasm_f32x4_replace_lane" âŠËœ 1â€¿2âŠ¸âŠ‘Â¨ all) âŠ all
allâˆ¾â†© {
  ret â† "v128_t"
  ext â† "simd128"
  n â† 128Ã·ğ•©
  name â† âˆ¾âŸ¨"wasm_i", â€¢Repr ğ•©, "x", â€¢Repr n, "_shuffle"âŸ©
  args â† âŸ¨"v128_t"â€¿"a", "v128_t"â€¿"b"âŸ© âˆ¾ {"const int" â‹ˆ "c"âˆ¾â€¢Repr ğ•©}Â¨ â†•n
  [
    "ret"â€¿"ext"â€¿"name"â€¿"args"
    retâ€¿extâ€¿nameâ€¿args
  ]
}Â¨ 8â€¿16â€¿32â€¿64

"../../data/wasm-1.json" â€¢FChars Export [
  "intrinsics"â€¿"licenseInfo"
  âŸ¨all, licenseNoteâˆ¾(4â¥Šlf)âˆ¾â€¢FChars DataIn "llvm-license-1.txt"âŸ©
]






# https://github.com/rust-lang/stdarch/blob/master/crates/core_arch/src/wasm32/simd128.rs
# insert docs from Rust intrinsics
# too rust-interface-centric :/
# {
#   text â† â€¢FChars DataIn "simd128.rs"
#   is2 â† âˆ§âˆ¾{(â‰ ğ•©)+/ğ•© â· text}Â¨ "pub fn"â€¿"pub unsafe fn"
#   names â† {sâ†ğ•©â†“text â‹„ " "âŠ¸âˆ¾â¼ sâ†‘ËœâŒŠÂ´sâŠ"(<"}Â¨ is2
#   lns â† /text=lf
#   l â† lnsâ‹is2
#   _decWhile â† {-âŸœ1â€¢_while_ğ”½}
#   descs â† {
#     e â† {âŠ‘((1+ğ•©âŠ‘lns)âŠ‘text)âˆŠ"#) "}_decWhile ğ•©
#     s â† {"///"â‰¡3â†‘(1+ğ•©âŠ‘lns)â†“text}_decWhile e
#     t â† {sâ€¿e: sâ†“eâ†‘text} âŸ¨s, e+1âŸ©âŠlns
#     ! âˆ¨Â´ "///" â· t
#     TrimWS {Â¬0âˆ¾(lfâˆ¾' ')â·ğ•©}âŠ¸/ {Â¬ âˆ¨âŸœÂ»âŸ2 0âˆ¾0â€¿0âˆ¾Ëœ(lfâˆ¾"///")â·ğ•©}âŠ¸/ t
#   }Â¨ l-2
#   â€¢Show â‰ all
#   â€¢Show 10â†‘5â†“Â¨ 1â€¿2âŠ¸âŠ‘Â¨ all
#   didx â† names âŠ {âˆ¨Â´"shuffle"â·ğ•©? @; ğ•©}Â¨ 5â†“Â¨ 1â€¿2âŠ¸âŠ‘Â¨ all
#   all {ğ•©â‰¡â‰ names? ğ•¨; ğ•¨ âˆ¾Ë˜ âŸ¨"desc", ğ•©âŠ‘descsâŸ©}Â¨â†© didx
# }
# if (desc) {
#   desc = desc.replace(/\n\n/g, '<br>').replace(/`([^`]+)`/g, '<code>$1</code>').replace(/\n/g, ' ');
# }
